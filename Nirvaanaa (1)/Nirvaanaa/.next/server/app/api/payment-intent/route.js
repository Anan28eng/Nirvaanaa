"use strict";(()=>{var e={};e.id=4481,e.ids=[4481],e.modules={11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25528:e=>{e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},35001:e=>{e.exports=require("cluster")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},33040:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>A,originalPathname:()=>N,patchFetch:()=>P,requestAsyncStorage:()=>b,routeModule:()=>q,serverHooks:()=>v,staticGenerationAsyncStorage:()=>x,staticGenerationBailout:()=>I});var i={};r.r(i),r.d(i,{POST:()=>S});var n=r(95419),a=r(69108),s=r(99678),o=r(78070),u=r(81355),d=r(82242),p=r(88578),c=r(65537),l=r(50798),m=r(74145),g=r(90943),y=r.n(g);r(6113);var h=r(30999);let f=new(y())({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_KEY_SECRET});async function S(e){let t=await (0,h.h)(e,"payment");if(t)return t;try{let t=await (0,u.getServerSession)(d.authOptions);if(!t)return o.Z.json({error:"Authentication required"},{status:401});if(!process.env.RAZORPAY_KEY_ID||!process.env.RAZORPAY_KEY_SECRET)return o.Z.json({error:"Razorpay is not configured. Please add RAZORPAY_KEY_ID and RAZORPAY_KEY_SECRET to your environment variables."},{status:500});await (0,p.Z)();let{items:r,shippingAddress:i,shipping:n,billingAddress:a,shippingMethod:s="Standard Shipping"}=await e.json(),g=i||n;if(!r||!Array.isArray(r)||0===r.length)return o.Z.json({error:"Cart items are required"},{status:400});if(!g)return o.Z.json({error:"Shipping address is required"},{status:400});let y=r.map(e=>({...e,productId:e.productId||e.id||e._id})),h=y.map(e=>e.productId).filter(Boolean);if(h.length!==y.length)return o.Z.json({error:"Invalid cart items"},{status:400});let S=await c.Z.find({_id:{$in:h}});if(S.length!==h.length)return o.Z.json({error:"Some products not found"},{status:400});let q=0,b=0,x=[];for(let e of y){let t=S.find(t=>t._id.toString()===e.productId);if(!t)return o.Z.json({error:`Product ${e.productId} not found`},{status:400});if(!t.published)return o.Z.json({error:`Product ${t.title} is not available`},{status:400});if("number"==typeof t.stock&&t.stock<e.quantity)return o.Z.json({error:`Insufficient stock for ${t.title}`},{status:400});let r="number"==typeof t.discount?t.discount:0,i=Math.round(t.price*(1-r/100)||0),n=i*e.quantity,a=(t.price||0)*e.quantity;q+=n,b+=Math.max(0,a-n),x.push({productId:t._id,name:t.title||t.name,image:Array.isArray(t.images)?"string"==typeof t.images[0]?t.images[0]:t.images[0]?.url||"":t.mainImage||"",price:i,originalPrice:t.price,discount:r,quantity:e.quantity,sku:t.sku,colorVariant:e.colorVariant||null})}let v=100,A=18,I=5;if(s){let e=await m.Z.findOne({name:s,isActive:!0});e&&(v=e.cost||100,A=e.gstPercent||18,e.estimatedDays&&("object"==typeof e.estimatedDays&&e.estimatedDays.max?I=e.estimatedDays.max:"number"==typeof e.estimatedDays&&(I=e.estimatedDays)))}let N=Math.round((q+v)*A/100),P=Math.round((q+v+N-b)*100),w=new l.Z({userId:t.user.id,items:x,subtotal:q,tax:N,shipping:v,discount:b,total:q+v+N-b,currency:"INR",paymentMethod:"razorpay",status:"pending",shippingAddress:g||i,billingAddress:a||g||i,shippingMethod:{name:s,estimatedDays:I}});await w.save();let R={amount:P,currency:"INR",receipt:w.orderNumber||w._id.toString(),notes:{orderId:w._id.toString(),userId:t.user.id,shipping:JSON.stringify(g||{})}},D=await f.orders.create(R);return w.razorpayOrderId=D.id,await w.save(),o.Z.json({orderId:w._id.toString(),razorpayOrderId:D.id,amount:P,currency:"INR",key:process.env.RAZORPAY_KEY_ID})}catch(e){if(console.error("Razorpay order creation error:",e),400===e.statusCode)return o.Z.json({error:e.error?.description||"Invalid payment request",details:e.error?.field?`Invalid field: ${e.error.field}`:void 0},{status:400});if(401===e.statusCode)return o.Z.json({error:"Invalid Razorpay credentials. Please check your API keys."},{status:401});return o.Z.json({error:e.message||"Failed to create payment order",details:void 0},{status:500})}}let q=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payment-intent/route",pathname:"/api/payment-intent",filename:"route",bundlePath:"app/api/payment-intent/route"},resolvedPagePath:"C:\\Users\\Ananya\\Downloads\\Nirvaanaa_current\\Nirvaanaa (1)\\Nirvaanaa\\app\\api\\payment-intent\\route.js",nextConfigOutput:"",userland:i}),{requestAsyncStorage:b,staticGenerationAsyncStorage:x,serverHooks:v,headerHooks:A,staticGenerationBailout:I}=q,N="/api/payment-intent/route";function P(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:x})}},30999:(e,t,r)=>{r.d(t,{h:()=>s});var i=r(34428),n=r(78070);let a={auth:new i.RateLimiterMemory({points:5,duration:900}),api:new i.RateLimiterMemory({points:100,duration:900}),payment:new i.RateLimiterMemory({points:10,duration:900}),admin:new i.RateLimiterMemory({points:30,duration:900})};async function s(e,t="api"){try{let r=a[t]||a.api,i=e.headers.get("x-forwarded-for"),n=i?i.split(",")[0]:e.headers.get("x-real-ip")||"unknown";return await r.consume(n),null}catch(e){return n.Z.json({error:"Too many requests. Please try again later.",retryAfter:Math.ceil(e.msBeforeNext/1e3)||60},{status:429,headers:{"Retry-After":Math.ceil(e.msBeforeNext/1e3)||60,"X-RateLimit-Limit":e.totalHits||100,"X-RateLimit-Remaining":0}})}}},50798:(e,t,r)=>{r.d(t,{Z:()=>s});var i=r(11185),n=r.n(i);let a=new(n()).Schema({orderNumber:{type:String,unique:!0},userId:{type:n().Schema.Types.ObjectId,ref:"User",required:!0},items:[{productId:{type:n().Schema.Types.ObjectId,ref:"Product",required:!0},name:{type:String,required:!0},image:{type:String,required:!0},price:{type:Number,required:!0,min:0},originalPrice:{type:Number,min:0,default:0},discount:{type:Number,min:0,default:0},quantity:{type:Number,required:!0,min:1},sku:String,colorVariant:{name:String,hex:String,images:[String]}}],subtotal:{type:Number,required:!0,min:0},tax:{type:Number,required:!0,min:0,default:0},shipping:{type:Number,required:!0,min:0,default:0},discount:{type:Number,required:!0,min:0,default:0},total:{type:Number,required:!0,min:0},currency:{type:String,required:!0,default:"INR"},status:{type:String,enum:["pending","processing","shipped","delivered","cancelled","refunded"],default:"pending"},paymentStatus:{type:String,enum:["pending","paid","failed","refunded"],default:"pending"},paymentMethod:{type:String,enum:["razorpay","cod"],required:!0},razorpayOrderId:{type:String,sparse:!0},razorpayPaymentId:{type:String,sparse:!0},shippingAddress:{name:{type:String,required:!0},phone:{type:String,required:!0},street:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},zipCode:{type:String,required:!0},country:{type:String,required:!0,default:"India"}},billingAddress:{name:{type:String,required:!0},phone:{type:String,required:!0},street:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},zipCode:{type:String,required:!0},country:{type:String,required:!0,default:"India"}},shippingMethod:{name:{type:String,required:!0,default:"Standard Shipping"},estimatedDays:{type:Number,required:!0,default:5},trackingNumber:String,trackingUrl:String},notes:{customer:String,admin:String},timeline:[{status:{type:String,required:!0},message:{type:String,required:!0},timestamp:{type:Date,default:Date.now},updatedBy:{type:n().Schema.Types.ObjectId,ref:"User"}}],emailSent:{confirmation:{type:Boolean,default:!1},shipped:{type:Boolean,default:!1},delivered:{type:Boolean,default:!1}},smsSent:{confirmation:{type:Boolean,default:!1},shipped:{type:Boolean,default:!1},delivered:{type:Boolean,default:!1}},refundAmount:{type:Number,min:0},refundReason:String,cancelledAt:Date,cancelledBy:{type:n().Schema.Types.ObjectId,ref:"User"},deliveredAt:Date},{timestamps:!0});a.index({orderNumber:1}),a.index({userId:1}),a.index({status:1}),a.index({paymentStatus:1}),a.index({createdAt:-1}),a.index({razorpayOrderId:1}),a.index({razorpayPaymentId:1}),a.index({"shippingAddress.phone":1}),a.virtual("orderSummary").get(function(){return{orderNumber:this.orderNumber,total:this.total,status:this.status,itemCount:this.items.length,createdAt:this.createdAt}}),a.virtual("customerInfo").get(function(){return{name:this.shippingAddress.name,phone:this.shippingAddress.phone,email:this.userId?.email}}),a.methods.addTimelineEntry=function(e,t,r=null){return this.timeline.push({status:e,message:t,timestamp:new Date,updatedBy:r}),this.save()},a.methods.updateStatus=function(e,t,r=null){return this.status=e,this.addTimelineEntry(e,t,r),"delivered"===e&&(this.deliveredAt=new Date),"cancelled"===e&&(this.cancelledAt=new Date,this.cancelledBy=r),this.save()},a.methods.calculateTotals=function(){return this.subtotal=this.items.reduce((e,t)=>e+t.price*t.quantity,0),this.total=this.subtotal+this.tax+this.shipping-this.discount,this.save()},a.statics.generateOrderNumber=async function(){let e=new Date,t=e.getFullYear().toString().slice(-2),r=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1),s=(await this.countDocuments({createdAt:{$gte:n,$lt:a}})+1).toString().padStart(3,"0");return`NV${t}${r}${i}${s}`},a.statics.findByUser=function(e){return this.find({userId:e}).sort({createdAt:-1})},a.statics.findPending=function(){return this.find({status:"pending"}).sort({createdAt:-1})},a.statics.findByStatus=function(e){return this.find({status:e}).sort({createdAt:-1})},a.pre("save",async function(e){this.isNew&&!this.orderNumber&&(this.orderNumber=await this.constructor.generateOrderNumber()),e()}),a.set("toJSON",{virtuals:!0,transform:function(e,t){return delete t.__v,t}});let s=n().models.Order||n().model("Order",a)},65537:(e,t,r)=>{r.d(t,{Z:()=>s});var i=r(11185),n=r.n(i);let a=new(n()).Schema({title:{type:String,required:[!0,"Product title is required"],trim:!0,maxlength:[100,"Title cannot be more than 100 characters"]},slug:{type:String,required:[!0,"Product slug is required"],unique:!0,lowercase:!0,trim:!0,match:[/^[a-z0-9-]+$/,"Slug can only contain lowercase letters, numbers, and hyphens"]},description:{type:String,required:[!0,"Product description is required"],maxlength:[2e3,"Description cannot be more than 2000 characters"]},shortDescription:{type:String,maxlength:[200,"Short description cannot be more than 200 characters"]},images:[{url:{type:String,required:!0},alt:{type:String,required:!0},publicId:{type:String,required:!0}}],price:{type:Number,required:[!0,"Product price is required"],min:[0,"Price cannot be negative"]},discount:{type:Number,min:[0,"Discount cannot be negative"],max:[100,"Discount cannot be more than 100%"],default:0},comparePrice:{type:Number,min:[0,"Compare price cannot be negative"]},stock:{type:Number,required:[!0,"Stock quantity is required"],min:[0,"Stock cannot be negative"],default:10},sku:{type:String,unique:!0,sparse:!0,trim:!0},tags:[{type:String,trim:!0,lowercase:!0}],category:{type:String,required:[!0,"Product category is required"],enum:["bangle-box","clutch","gift-hampers","goggle-cover","kitty-bag","long-tote-bag","picnic-bag","potli-purse","sling-bags","velvet-clutch-with-flaps"]},subcategory:{type:String,trim:!0},materials:[{type:String,trim:!0}],dimensions:{length:Number,width:Number,height:Number,unit:{type:String,enum:["cm","inches"],default:"cm"}},weight:{value:Number,unit:{type:String,enum:["g","kg","lbs"],default:"g"}},colors:[{name:String,hex:String}],colorVariants:[{name:{type:String,required:!0,trim:!0},hex:{type:String,required:!0,match:[/^#[0-9A-Fa-f]{6}$/,"Hex color must be in format #RRGGBB"]},images:[{type:String,trim:!0}]}],published:{type:Boolean,default:!0},featured:{type:Boolean,default:!1},seo:{metaTitle:{type:String,maxlength:[60,"Meta title cannot be more than 60 characters"]},metaDescription:{type:String,maxlength:[160,"Meta description cannot be more than 160 characters"]},keywords:[String]},ratings:{average:{type:Number,default:0,min:0,max:5},count:{type:Number,default:0,min:0}},salesCount:{type:Number,default:0,min:0},isHandmade:{type:Boolean,default:!0},madeIn:{type:String,default:"India"},careInstructions:{type:String,maxlength:[500,"Care instructions cannot be more than 500 characters"]}},{timestamps:!0});a.index({slug:1}),a.index({category:1}),a.index({tags:1}),a.index({published:1}),a.index({featured:1}),a.index({"ratings.average":-1}),a.index({salesCount:-1}),a.index({createdAt:-1}),a.set("toJSON",{virtuals:!0,transform:function(e,t){return delete t.__v,t}}),a.virtual("discountPercentage").get(function(){return this.comparePrice&&this.comparePrice>this.price?Math.round((this.comparePrice-this.price)/this.comparePrice*100):0}),a.virtual("inStock").get(function(){return this.stock>0}),a.virtual("mainImage").get(function(){return this.images.length>0?this.images[0]:null}),a.methods.updateStock=function(e){return this.stock=Math.max(0,this.stock-e),this.save()},a.methods.incrementSales=function(e=1){return this.salesCount+=e,this.save()},a.statics.findPublished=function(){return this.find({published:!0})},a.statics.findFeatured=function(){return this.find({published:!0,featured:!0})},a.statics.findByCategory=function(e){return this.find({published:!0,category:e})},a.statics.search=function(e){return this.find({published:!0,$or:[{title:{$regex:e,$options:"i"}},{description:{$regex:e,$options:"i"}},{tags:{$in:[RegExp(e,"i")]}}]})},a.pre("save",function(e){!this.slug&&this.title&&(this.slug=this.title.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim("-")),e()}),a.set("toJSON",{virtuals:!0,transform:function(e,t){return delete t.__v,t}});let s=n().models.Product||n().model("Product",a)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[1638,6206,6521,2455,1355,4136,4428,2089,943,1671],()=>r(33040));module.exports=i})();