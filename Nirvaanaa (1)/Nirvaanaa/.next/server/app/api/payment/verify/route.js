"use strict";(()=>{var e={};e.id=2872,e.ids=[2872],e.modules={11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},35001:e=>{e.exports=require("cluster")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},43551:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>x,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>q,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>b});var i={};r.r(i),r.d(i,{POST:()=>g});var n=r(95419),a=r(69108),s=r(99678),u=r(78070),o=r(90943),d=r.n(o),p=r(6113),c=r.n(p),l=r(88578),m=r(50798),y=r(30999);async function g(e){let t=await (0,y.h)(e,"payment");if(t)return t;try{let{razorpay_order_id:t,razorpay_payment_id:r,razorpay_signature:i,orderId:n}=await e.json();if(!t||!r||!i)return u.Z.json({error:"Missing payment verification data"},{status:400});if(!process.env.RAZORPAY_KEY_ID||!process.env.RAZORPAY_KEY_SECRET)return u.Z.json({error:"Razorpay is not configured. Payments are disabled in this environment."},{status:503});if(!function(e,t,r,i){let n=`${e}|${t}`,a=c().createHmac("sha256",i).update(n).digest("hex");return c().timingSafeEqual(Buffer.from(r),Buffer.from(a))}(t,r,i,process.env.RAZORPAY_KEY_SECRET))return u.Z.json({error:"Invalid payment signature",success:!1},{status:400});await (0,l.Z)();let a=await m.Z.findById(n);if(!a)return u.Z.json({error:"Order not found",success:!1},{status:404});let s=new(d())({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_KEY_SECRET});try{let e=await s.payments.fetch(r);if("captured"===e.status&&e.order_id===t)return"paid"!==a.paymentStatus&&(a.paymentStatus="paid",a.status="processing",a.razorpayPaymentId=r,a.razorpayOrderId=t,a.addTimelineEntry&&a.addTimelineEntry("processing","Payment verified and order is being processed",null),await a.save()),u.Z.json({success:!0,message:"Payment verified successfully",orderId:a._id.toString(),paymentId:r});return u.Z.json({error:"Payment not captured",success:!1},{status:400})}catch(e){return console.error("Razorpay payment fetch error:",e),u.Z.json({error:"Failed to verify payment with Razorpay",success:!1},{status:500})}}catch(e){return console.error("Payment verification error:",e),u.Z.json({error:"Payment verification failed",success:!1},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payment/verify/route",pathname:"/api/payment/verify",filename:"route",bundlePath:"app/api/payment/verify/route"},resolvedPagePath:"C:\\Users\\Ananya\\Downloads\\Nirvaanaa_current\\Nirvaanaa (1)\\Nirvaanaa\\app\\api\\payment\\verify\\route.js",nextConfigOutput:"",userland:i}),{requestAsyncStorage:h,staticGenerationAsyncStorage:S,serverHooks:q,headerHooks:v,staticGenerationBailout:b}=f,x="/api/payment/verify/route";function A(){return(0,s.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:S})}},88578:(e,t,r)=>{r.d(t,{Z:()=>u});var i=r(11185),n=r.n(i);let a=process.env.MONGODB_URI;if(!a)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let u=async function(){if(s.conn)return s.conn;s.promise||(s.promise=n().connect(a,{bufferCommands:!1}).then(e=>e));try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},30999:(e,t,r)=>{r.d(t,{h:()=>s});var i=r(34428),n=r(78070);let a={auth:new i.RateLimiterMemory({points:5,duration:900}),api:new i.RateLimiterMemory({points:100,duration:900}),payment:new i.RateLimiterMemory({points:10,duration:900}),admin:new i.RateLimiterMemory({points:30,duration:900})};async function s(e,t="api"){try{let r=a[t]||a.api,i=e.headers.get("x-forwarded-for"),n=i?i.split(",")[0]:e.headers.get("x-real-ip")||"unknown";return await r.consume(n),null}catch(e){return n.Z.json({error:"Too many requests. Please try again later.",retryAfter:Math.ceil(e.msBeforeNext/1e3)||60},{status:429,headers:{"Retry-After":Math.ceil(e.msBeforeNext/1e3)||60,"X-RateLimit-Limit":e.totalHits||100,"X-RateLimit-Remaining":0}})}}},50798:(e,t,r)=>{r.d(t,{Z:()=>s});var i=r(11185),n=r.n(i);let a=new(n()).Schema({orderNumber:{type:String,unique:!0},userId:{type:n().Schema.Types.ObjectId,ref:"User",required:!0},items:[{productId:{type:n().Schema.Types.ObjectId,ref:"Product",required:!0},name:{type:String,required:!0},image:{type:String,required:!0},price:{type:Number,required:!0,min:0},originalPrice:{type:Number,min:0,default:0},discount:{type:Number,min:0,default:0},quantity:{type:Number,required:!0,min:1},sku:String,colorVariant:{name:String,hex:String,images:[String]}}],subtotal:{type:Number,required:!0,min:0},tax:{type:Number,required:!0,min:0,default:0},shipping:{type:Number,required:!0,min:0,default:0},discount:{type:Number,required:!0,min:0,default:0},total:{type:Number,required:!0,min:0},currency:{type:String,required:!0,default:"INR"},status:{type:String,enum:["pending","processing","shipped","delivered","cancelled","refunded"],default:"pending"},paymentStatus:{type:String,enum:["pending","paid","failed","refunded"],default:"pending"},paymentMethod:{type:String,enum:["razorpay","cod"],required:!0},razorpayOrderId:{type:String,sparse:!0},razorpayPaymentId:{type:String,sparse:!0},shippingAddress:{name:{type:String,required:!0},phone:{type:String,required:!0},street:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},zipCode:{type:String,required:!0},country:{type:String,required:!0,default:"India"}},billingAddress:{name:{type:String,required:!0},phone:{type:String,required:!0},street:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},zipCode:{type:String,required:!0},country:{type:String,required:!0,default:"India"}},shippingMethod:{name:{type:String,required:!0,default:"Standard Shipping"},estimatedDays:{type:Number,required:!0,default:5},trackingNumber:String,trackingUrl:String},notes:{customer:String,admin:String},timeline:[{status:{type:String,required:!0},message:{type:String,required:!0},timestamp:{type:Date,default:Date.now},updatedBy:{type:n().Schema.Types.ObjectId,ref:"User"}}],emailSent:{confirmation:{type:Boolean,default:!1},shipped:{type:Boolean,default:!1},delivered:{type:Boolean,default:!1}},smsSent:{confirmation:{type:Boolean,default:!1},shipped:{type:Boolean,default:!1},delivered:{type:Boolean,default:!1}},refundAmount:{type:Number,min:0},refundReason:String,cancelledAt:Date,cancelledBy:{type:n().Schema.Types.ObjectId,ref:"User"},deliveredAt:Date},{timestamps:!0});a.index({userId:1}),a.index({status:1}),a.index({paymentStatus:1}),a.index({createdAt:-1}),a.index({"shippingAddress.phone":1}),a.virtual("orderSummary").get(function(){return{orderNumber:this.orderNumber,total:this.total,status:this.status,itemCount:this.items.length,createdAt:this.createdAt}}),a.virtual("customerInfo").get(function(){return{name:this.shippingAddress.name,phone:this.shippingAddress.phone,email:this.userId?.email}}),a.methods.addTimelineEntry=function(e,t,r=null){return this.timeline.push({status:e,message:t,timestamp:new Date,updatedBy:r}),this.save()},a.methods.updateStatus=function(e,t,r=null){return this.status=e,this.addTimelineEntry(e,t,r),"delivered"===e&&(this.deliveredAt=new Date),"cancelled"===e&&(this.cancelledAt=new Date,this.cancelledBy=r),this.save()},a.methods.calculateTotals=function(){return this.subtotal=this.items.reduce((e,t)=>e+t.price*t.quantity,0),this.total=this.subtotal+this.tax+this.shipping-this.discount,this.save()},a.statics.generateOrderNumber=async function(){let e=new Date,t=e.getFullYear().toString().slice(-2),r=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1),s=(await this.countDocuments({createdAt:{$gte:n,$lt:a}})+1).toString().padStart(3,"0");return`NV${t}${r}${i}${s}`},a.statics.findByUser=function(e){return this.find({userId:e}).sort({createdAt:-1})},a.statics.findPending=function(){return this.find({status:"pending"}).sort({createdAt:-1})},a.statics.findByStatus=function(e){return this.find({status:e}).sort({createdAt:-1})},a.pre("save",async function(e){this.isNew&&!this.orderNumber&&(this.orderNumber=await this.constructor.generateOrderNumber()),e()}),a.set("toJSON",{virtuals:!0,transform:function(e,t){return delete t.__v,t}});let s=n().models.Order||n().model("Order",a)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[1638,6206,4136,4428,2089,943],()=>r(43551));module.exports=i})();